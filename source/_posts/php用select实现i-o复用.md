---
title: php用select实现I/O复用
tags: []
id: '63'
categories:
  - - uncategorized
date: 2020-09-23 06:48:44
---

在Linux Socket服务器短编程时，为了处理大量客户的连接请求，需要使用非阻塞I/O和复用，select、poll和epoll是Linux API提供的I/O复用方式，其实I/O多路复用就是通过一种机制，可以监视多个描述符，一旦某个描述符就绪(一般是读就绪或者写就绪)，能够通知程序进行相应的读写操作。但select，poll，epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的。现在比较受欢迎的的nginx就是使用epoll来实现I/O复用支持高并发，所以理解好select，poll，epoll对于nginx如何应对高并发还是很有帮助的。

### select调用过程

![](http://qiniu.gaobinzhan.com/2019/12/24/2937c31e6dc23.png)

### select缺点

*   单个进程监控的文件描述符有限，通常为1024\*8个文件描述符。
    
    当然可以改进，由于select采用轮询方式扫描文件描述符。文件描述符数量越多，性能越差。
    
*   内核/用户数据拷贝频繁，操作复杂。
    
    select在调用之前，需要手动在应用程序里将要监控的文件描述符添加到fed\_set集合中。然后加载到内核进行监控。用户为了检测时间是否发生，还需要在用户程序手动维护一个数组，存储监控文件描述符。当内核事件发生，在将fed\_set集合中没有发生的文件描述符清空，然后拷贝到用户区，和数组中的文件描述符进行比对。再调用selecct也是如此。每次调用，都需要了来回拷贝。
    
*   轮回时间效率低
    
    select返回的是整个数组的句柄。应用程序需要遍历整个数组才知道谁发生了变化。轮询代价大。
    
*   select是水平触发
    
    应用程序如果没有完成对一个已经就绪的文件描述符进行IO操作。那么之后select调用还是会将这些文件描述符返回，通知进程。
    

### 代码实现

Worker.php